<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Planet Microbe Search Demo</title>

    <!-- Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

    <!-- Elm -->
    <script src="./elm.js"></script>
  </head>
  <body>
    <div id="main"></div>
    <script>
var app = Elm.Main.init({
  node: document.getElementById('main')
});

var gmap, markers = [], shapes = [], features = [];
app.ports.loadMap.subscribe(function(model) {
    console.log("loadMap: model:", model);

    if (!gmap) {
      var mapDiv = document.getElementsByTagName('gmap')[0]; // TODO add support for more than one map in a page
      if (!mapDiv) {
        throw("Error: map div not found");
      }

      var myLatlng = new google.maps.LatLng(0, 0);
      var mapOptions = {
          zoom: 2,
          center: myLatlng
      };
      gmap = new google.maps.Map(mapDiv, mapOptions);

      var drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: true,
        drawingControlOptions: {
          position: google.maps.ControlPosition.TOP_CENTER,
          drawingModes: ['circle'] //['marker', 'circle', 'polygon', 'polyline', 'rectangle']
        },
        circleOptions: {
          fillColor: 'lightgray',
          fillOpacity: 0.4,
          strokeColor: 'gray',
          strokeOpacity: 0.8,
          strokeWeight: 1,
          clickable: false,
          editable: true,
          draggable: true,
          zIndex: 1
        }
      });
      drawingManager.setMap(gmap);

      google.maps.event.addListener(drawingManager, 'circlecomplete', function(circle) {
        var radius = circle.getRadius();
        console.log("circle:", radius);
        for (var i = 0; i < shapes.length; i++) {
          shapes[i].setMap(null);
        }
        shapes.push(circle);
      });
    }
    else { // reset map
      // Clear all markers, rectangles, and features
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
      makers = [];

      for (var i = 0; i < features.length; i++) {
        gmap.data.remove(features[i]);
      }
      features = [];
    }

    if (!model || !Object.keys(model).length)
      return;

    model.forEach(cluster => {
      let circle = gmap.data.addGeoJson({ type: "Feature", id: 123, "geometry": JSON.parse(cluster.circle) });
      features = features.concat(circle);

      let centroid = JSON.parse(cluster.centroid)

      let marker = new google.maps.Marker({
          position: new google.maps.LatLng(centroid.coordinates[1], centroid.coordinates[0]),
          map: gmap,
          label: { text: cluster.count.toString(), color: "white" }
      });
      markers.push(marker);
    });

    /*var rectangle = new google.maps.Rectangle({
      map: gmap,
      bounds: {
        north: 20,
        south: 50,
        east: -150,
        west: -200
      },
      strokeColor: 'gray',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: 'lightgray',
      fillOpacity: 0.35,
      editable: true,
      draggable: true
    });
    shapes.push(rectangle);
    */
});

/*app.ports.setCenter.subscribe(function(model) {
    var myLatlng = new google.maps.LatLng(model.center.lat, model.center.lng);
    model.gmap.setCenter(myLatlng);
});*/
    </script>

    <!-- GoogleMaps -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIQ7aSxFXmmx8oEAZ2KNPOyGiSkuj9hdA&libraries=drawing" type="text/javascript"></script> <!-- FIXME -->
  </body>
</html>
