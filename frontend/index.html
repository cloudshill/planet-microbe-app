<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Planet Microbe Search Demo</title>

    <!-- Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

    <!-- Elm -->
    <script src="./elm.js"></script>
  </head>
  <body>
    <div id="main"></div>
    <script>
var app = Elm.Main.init({
  node: document.getElementById('main')
});

var gmap, markerClusterer, initMap = true, markers = [], shapes = [], features = [];
app.ports.loadMap.subscribe(function(results) {
    console.log("loadMap");//: results:", results);

    if (!gmap) {
      var mapDiv = document.getElementsByTagName('gmap')[0]; // TODO add support for more than one map in a page
      if (!mapDiv) {
        throw("Error: map div not found");
      }

      gmap = new google.maps.Map(mapDiv, {
          zoom: 2,
          center: new google.maps.LatLng(0, 0)
      });

      var drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: true,
        drawingControlOptions: {
          position: google.maps.ControlPosition.TOP_CENTER,
          drawingModes: ['circle'] //['marker', 'circle', 'polygon', 'polyline', 'rectangle']
        },
        circleOptions: {
          fillColor: 'lightgray',
          fillOpacity: 0.4,
          strokeColor: 'gray',
          strokeOpacity: 0.8,
          strokeWeight: 1,
          clickable: false,
          editable: true,
          draggable: true,
          zIndex: 1
        }
      });
      drawingManager.setMap(gmap);

      google.maps.event.addListener(drawingManager, 'circlecomplete',
        function(circle) {
          console.log("circlecomplete");
          // Remove current circles, only show latest one on the map at a time
          for (var i = 0; i < shapes.length; i++) {
            shapes[i].setMap(null);
          }
          shapes.push(circle);

          handleCircleEvent.apply(circle);
          circle.addListener('radius_changed', handleCircleEvent.bind(circle));
          circle.addListener('center_changed', handleCircleEvent.bind(circle));
        }
      );

      gmap.addListener('zoom_changed',
        function() {
          zoom = gmap.getZoom();
          if (zoom >= 4) {
            for (var i = 0; i < markers.length; i++) {
              let marker = markers[i];
              let label = marker.customData.project_name + " - " + marker.customData.sample_accn
              marker.setLabel(label);
            }
          }
          else {
            for (var i = 0; i < markers.length; i++) {
              markers[i].setLabel("");
            }
          }
        }
      );

      markerClusterer = new MarkerClusterer(gmap, [],
        { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
          //gridSize: 50,
          maxZoom: 15,
          averageCenter: true
        }
      );
    }
    else { // reset map
      // Clear all markers, rectangles, and features
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
      markers = [];
      markerClusterer.clearMarkers();

      /*for (var i = 0; i < features.length; i++) {
        gmap.data.remove(features[i]);
      }
      features = [];*/

      google.maps.event.clearListeners(gmap, 'radius_changed');
    }

    if (!results || results.length == 0)
      return;

    var bounds = new google.maps.LatLngBounds();

    /*model.forEach(cluster => {
      let circle = gmap.data.addGeoJson({ type: "Feature", id: 123, "geometry": JSON.parse(cluster.circle) });
      features = features.concat(circle);

      let centroid = JSON.parse(cluster.centroid)

      let marker = new google.maps.Marker({
          position: new google.maps.LatLng(centroid.coordinates[1], centroid.coordinates[0]),
          map: gmap,
          label: { text: cluster.count.toString(), color: "white" }
      });
      markers.push(marker);

      bounds.extend(marker.position);
    });*/

    results.forEach(result => {
      let marker = new google.maps.Marker({
          position: new google.maps.LatLng(result.latitude, result.longitude),
          customData: {
            sample_accn: result.sample_accn,
            project_name: result.project_name
          }
          //map: gmap
      });
      markers.push(marker);

      bounds.extend(marker.position);
    });
    markerClusterer.addMarkers(markers);
    console.log("markers:", markerClusterer.getMarkers().length);

    /*if (initMap) {
      gmap.fitBounds(bounds);
      gmap.setZoom(2);
      initMap = false;
    }*/
});

function handleCircleEvent() {
  console.log("handleCircleEvent:", this);

  // Send selected circle coords to Elm
  app.ports.getLocation.send({
    lat: this.center.lat(),
    lng: this.center.lng(),
    radius: this.getRadius()
  });
}

app.ports.setLocation.subscribe(function(location) {
  console.log("setLocation:", location);
  for (var i = 0; i < shapes.length; i++) {
    circle = shapes[i];
    console.log(circle);
    google.maps.event.clearListeners(circle, 'radius_changed');
    google.maps.event.clearListeners(circle, 'center_changed');
    circle.setCenter(new google.maps.LatLng(location.lat,location.lng));
    circle.setRadius(location.radius);
    circle.addListener('radius_changed', handleCircleEvent.bind(circle));
    circle.addListener('center_changed', handleCircleEvent.bind(circle));
  }
});
    </script>

    <!-- GoogleMaps -->
    <!--<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>-->
    <script src="https://cdn.rawgit.com/googlemaps/js-marker-clusterer/gh-pages/src/markerclusterer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIQ7aSxFXmmx8oEAZ2KNPOyGiSkuj9hdA&libraries=drawing" type="text/javascript"></script> <!-- FIXME -->
  </body>
</html>
