<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Planet Microbe Search Demo</title>

    <!-- Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">

    <!-- Elm-DatePicker -->
<!--    <link rel="stylesheet" href="assets/css/elm-datepicker.css">-->

    <!-- Landing page -->
    <link rel="stylesheet" href="assets/css/landing-page.css">

    <!-- Spinner -->
    <link rel="stylesheet" href="assets/css/loader.css">

    <!-- Elm -->
    <script src="./elm.js"></script>
  </head>
  <body>
    <div id="main"></div>
    <script>
var app = Elm.Main.init({
  node: document.getElementById('main')
});

var gmap,
  drawingManager,
  markerClusterer,
  markers = [],
  shapes = [],
  features = [],
  mapSettings = {
    showDrawingManager: true,
    showMarkerClusters: true,
    fitBounds: false,
  };

function initMap() {
  console.log("initMap");

  var mapDiv = document.getElementsByTagName('gmap')[0]; // TODO add support for more than one map in a page
  if (!mapDiv)
    throw("initMap: map div not found");

  gmap = new google.maps.Map(mapDiv, {
      zoom: 2,
      //minZoom: 1,
      center: new google.maps.LatLng(0, 0),
      streetViewControl: false
  });

  drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: null,
    drawingControl: mapSettings.showDrawingManager,
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_CENTER,
      drawingModes: ['circle'] //['marker', 'circle', 'polygon', 'polyline', 'rectangle']
    },
    circleOptions: {
      fillColor: 'lightgray',
      fillOpacity: 0.4,
      strokeColor: 'gray',
      strokeOpacity: 0.8,
      strokeWeight: 1,
      clickable: false,
      editable: true,
      draggable: true,
      zIndex: 1
    }
  });
  drawingManager.setMap(gmap);

  google.maps.event.addListener(drawingManager, 'circlecomplete',
    function(circle) {
      console.log("circlecomplete");
      // Remove current circles, only show latest one on the map at a time
      for (var i = 0; i < shapes.length; i++) {
        shapes[i].setMap(null);
      }
      shapes.push(circle);

      handleCircleEvent.apply(circle);
      circle.addListener('radius_changed', handleCircleEvent.bind(circle));
      circle.addListener('center_changed', handleCircleEvent.bind(circle));
    }
  );

  // Listen on circle selection button to clear selection
  google.maps.event.addListener(drawingManager, "drawingmode_changed", function() {
    console.log("drawing mode changed:"+drawingManager.getDrawingMode());
    if (drawingManager.getDrawingMode() == "circle" && shapes.length > 0) {
      for (var i = 0; i < shapes.length; i++) {
        shapes[i].setMap(null);
      }
      app.ports.getLocation.send(null);
    }
  });

  gmap.addListener('zoom_changed',
    function() {
      zoom = gmap.getZoom();
      if (zoom >= 4) {
        for (var i = 0; i < markers.length; i++) {
          let marker = markers[i];
          let label = "";
          if (marker.customData.project_name && marker.customData.sample_accn)
            label = marker.customData.project_name + " - " + marker.customData.sample_accn
          marker.setLabel(label);
        }
      }
      else {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setLabel("");
        }
      }
    }
  );

  markerClusterer = new MarkerClusterer(gmap, [],
    { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
      //gridSize: 50,
      maxZoom: 15,
      averageCenter: true
    }
  );
}

function resetMap(results) { // TODO only clear markers that aren't in new results
  // Clear all markers
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
  }
  markers = [];
  if (markerClusterer)
    markerClusterer.clearMarkers();

  /*for (var i = 0; i < features.length; i++) {
    gmap.data.remove(features[i]);
  }
  features = [];*/

  if (gmap)
    google.maps.event.clearListeners(gmap, 'radius_changed');
}

app.ports.removeMap.subscribe(function() {
  console.log("removeMap");
  resetMap();
  gmap = null;
});

app.ports.changeMapSettings.subscribe(function(settings) {
  console.log("changeMapSettings");
  mapSettings = settings;
});

app.ports.loadMap.subscribe(function(results) {
  console.log("loadMap");//: results:", results);

  if (!gmap)
    initMap();
  else
    resetMap(results);

  if (!results || results.length == 0) {
    console.log("loadMap: no results");
    return;
  }

  var bounds = new google.maps.LatLngBounds();

  /*model.forEach(cluster => {
    let circle = gmap.data.addGeoJson({ type: "Feature", id: 123, "geometry": JSON.parse(cluster.circle) });
    features = features.concat(circle);

    let centroid = JSON.parse(cluster.centroid)

    let marker = new google.maps.Marker({
        position: new google.maps.LatLng(centroid.coordinates[1], centroid.coordinates[0]),
        map: gmap,
        label: { text: cluster.count.toString(), color: "white" }
    });
    markers.push(marker);

    bounds.extend(marker.position);
  });*/

  results.forEach(result => {
    let marker = new google.maps.Marker({
        position: new google.maps.LatLng(result.latitude, result.longitude),
        customData: {
          sample_accn: result.sample_accn,
          project_name: result.project_name
        },
        url: (result.sample_id ? "#/samples/" + result.sample_id : null)
        //map: gmap // set below
    });
    marker.addListener("click",
      function() {
        console.log("click");
        if (this.url)
          //window.open(this.url, '_blank');
          window.location.href = this.url;
      }
    );
    markers.push(marker);

    bounds.extend(marker.position);
  });

  if (mapSettings.showMarkerClusters)
    markerClusterer.addMarkers(markers);
  else {
    for (i = 0; i < markers.length; i++)
      markers[i].setMap(gmap);
  }
  console.log("markers:", markers.length); //markerClusterer.getMarkers().length);

  if (mapSettings.fitBounds) {
    //gmap.fitBounds(bounds);
    gmap.setZoom(0);
  }

  app.ports.mapLoaded.send(true);
});

function handleCircleEvent() {
  console.log("handleCircleEvent:", this);

  // Send selected circle coords to Elm
  app.ports.getLocation.send({
    lat: this.center.lat(),
    lng: this.center.lng(),
    radius: this.getRadius()
  });
}

app.ports.setLocation.subscribe(function(location) {
  console.log("setLocation:", location);
  if (!location) {
    for (var i = 0; i < shapes.length; i++) {
      shapes[i].setMap(null);
    }
  }
  else {
    for (var i = 0; i < shapes.length; i++) {
      circle = shapes[i];
      console.log(circle);
      google.maps.event.clearListeners(circle, 'radius_changed');
      google.maps.event.clearListeners(circle, 'center_changed');
      circle.setCenter(new google.maps.LatLng(location.lat,location.lng));
      circle.setRadius(location.radius);
      circle.addListener('radius_changed', handleCircleEvent.bind(circle));
      circle.addListener('center_changed', handleCircleEvent.bind(circle));
    }
  }
});
    </script>

    <!-- GoogleMaps -->
    <!--<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>-->
    <script src="https://cdn.rawgit.com/googlemaps/js-marker-clusterer/gh-pages/src/markerclusterer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIQ7aSxFXmmx8oEAZ2KNPOyGiSkuj9hdA&libraries=drawing" type="text/javascript"></script> <!-- FIXME -->
  </body>
</html>
